<context>
# Overview  
Salvo Phase 2: Political Engagement Platform transforms the existing tactical coordination app into a real-world voter mobilization tool for the 2026 midterm elections. Built on top of the working MVP (auth, directives, map, offline sync), this phase adds: mission creation dropdown for Captains, address-to-district auto-assignment, digital ballot voting guide, notification discipline strategy, and easy social media link opening. Primary target: 10,000+ verified voters in Montgomery County, Maryland. Designed for scalability to Florida Governor race, South Carolina races, and nationwide expansion. Success metric: High notification opt-in rate (>80%), active mission completion, voter registration increases, and election day turnout.

# Core Features  
**Mission Creation Dropdown System**: Captains create missions via intuitive dropdown menu with 7 types: Recruit Friends (100 XP), Signal Boost (50 XP), Raid Comments (75 XP), Phone/Email Protest (150 XP), PFP Change (25 XP), Event Attendance (100 XP), Voter Registration (150 XP). Each type auto-assigns verification method (photo/screenshot/manual) and fixed XP. Dynamic form shows relevant fields: URLs for social missions, scripts for phone protests, keywords for raids. Scope selector: District/County/State/National. No more manual XP entry - all standardized.

**Address-to-District Auto-Assignment**: Onboarding includes address entry screen (after age/gender, before feature selection). Mapbox Geocoding API converts address → lat/lng → Maryland Legislative District + County + Congressional District. Users auto-assigned to correct legislative_district for scoped missions and notifications. Replaces warrior_bands concept with geographic hierarchy. **Role Hierarchy**: National → State → County → Captain (District) → Warrior (User). **Captain Assignment**: County leaders, State leaders, or National leaders assign Captains to districts. Once assigned, Captain is the **sole person** sending missions for their Legislative District. County leaders can send missions to specific districts within their county OR to entire county. Scalable data model supports full Maryland (all 47 districts, 23 counties) with initial focus on Montgomery County + MD-6, then multi-state expansion (Florida, South Carolina, etc.).

**Digital Ballot Voting Guide**: "Main Quest" screen displays replica of user's local ballot with endorsed candidates highlighted in Neon Green. Leadership creates ballots per election/district. Down-ballot races shown (Governor, Senate, House, County Exec, School Board, etc.). Feels like "voting for your team to win." Users commit to vote for endorsed candidates. Completionist badge: High XP only if user verifies voting for ALL endorsed down-ballot seats. Critical for driving turnout on actual election day.

**Notification Discipline & Retention**: Notifications are valuable intelligence, not spam. Only send: (1) New missions in user's scope, (2) Election day reminders (not daily spam), (3) Critical updates (e.g., Polymarket odds shifts >3% - future), (4) Mission verification results. Onboarding warning: "Disabling notifications means missing critical election night intel." Track notification permission status. Goal: >80% opt-in rate year-round. Users WANT notifications because they're election-critical.

**Easy Social Media Link Opening**: Signal Boost and Raid missions include one-tap clickable URLs. Opens Twitter/X, Reddit, Instagram, YouTube in native app (if installed) or in-app browser via expo-web-browser. Mission cards show "Open Link" button. Deep link support for major platforms. Makes "raiding" target posts/comment sections frictionless. Users can engage with content in seconds.

**Map Territory Game (Stretch Goal - Optional)**: Increase H3 resolution from Res 9 to Res 7-8 (larger hexes for "conquer" feel). Leadership (County/State level) can mark "enemy territory" hexes (opponent strongholds, polling places). Users check in to "siege" and convert hexes to team color. Daily/weekly competitive game. If too complex for timeline, remove this feature entirely. Map improvements are nice-to-have, not critical path.

**Scalable Multi-State Architecture**: Database schema supports multiple states, counties, districts. Maryland first (Montgomery County), then expand to Florida (Governor race), South Carolina, and beyond. Geographic hierarchy: State → County → Legislative District → Users. Captains can be assigned per state/district. Missions can be scoped to specific states. National missions reach all users. Built for nationwide scale from day one.

# User Experience  
**User Personas**: 
- **Warrior (Voter)**: Age 18-65, politically engaged, wants to help "their team win." Completes missions, recruits friends, keeps notifications on to never miss election intel. Needs simple, clear instructions and instant gratification (XP/rank).
- **Captain (District Leader)**: Assigned by County/State/National leaders. Runs ONE legislative district (e.g., Maryland District 15). **Sole person** creating missions for their district. Monitors district stats, recruits members. Needs easy mission creation UI.
- **County Leader**: Oversees entire county (e.g., Montgomery County). Assigns Captains to districts within county. Can send missions to specific districts OR entire county. Monitors county-wide stats.
- **State Leader**: Oversees entire state (e.g., Maryland). Assigns County leaders and Captains. Creates ballots with endorsed candidates. Can send missions to specific districts, counties, OR entire state. Launches state-wide initiatives.
- **National Leader**: Top of hierarchy. Oversees all states. Assigns State leaders. Can send missions anywhere. Creates national campaigns.

**Key User Flows**:
1. **New User Onboarding**: Sign up → Oath screen → Personal details (age/gender) → **Address entry (NEW)** → Feature preferences → **Security Clearance Mission (verify voter registration - FUTURE)** → Main app
2. **County Leader Assigns Captain**: HQ Tab → Leadership → View Districts → Selects "Maryland District 15" → Taps "Assign Captain" → Search users in district → Selects user → Confirms → User promoted to Captain role → Captain receives notification → Captain can now create missions for District 15
3. **Captain Creates Mission**: HQ Tab → Missions → Dropdown selects "Signal Boost" → Enters target URL, description, selects platform → Scope auto-set to "District" (Captain's district) → Auto-shows XP reward (50 XP) → Create Mission → Appears in Command Feed for users in District 15
4. **County Leader Creates County-Wide Mission**: HQ Tab → Missions → Dropdown selects "Voter Registration" → Enters description → Selects scope "County" (Montgomery County) → Auto-shows XP reward (150 XP) → Create Mission → Appears in Command Feed for ALL users in Montgomery County
5. **Warrior Completes Mission**: Views Command Feed → Taps "SIGNAL BOOST: Share this post" → Taps "Open Link" → Twitter opens → User likes/retweets post → Returns to app → Taps "Upload Proof" → Takes screenshot → Submits → Gemini verifies keyword/engagement → XP awarded → Notification sent
6. **Election Day Flow**: User receives notification "ELECTION DAY: Vote for our team!" → Opens Main Quest (Ballot Guide) → Sees endorsed candidates in Neon Green for all races → Goes to polls → Votes for endorsed candidates → Returns to app → Uploads "I Voted" sticker photo → Verifies voting for all endorsed races → Receives Completionist Badge + High XP

**UI/UX Considerations**:
- **Citizen-style Dark Theme**: Already implemented. Maintain consistency across all new screens.
- **Mission Creation Must Be Dead Simple**: Dropdown, dynamic fields, one-click create. No room for Captain error.
- **Ballot Guide Must Feel Like Real Ballot**: Mirror actual ballot design. Neon Green highlights make endorsements obvious. "Vote for our team" framing.
- **Notifications Must Feel Valuable**: Short, urgent, action-oriented. "New mission in your district" not "Hey check out the app!"
- **One-Tap Actions**: Open link, upload proof, verify mission. Minimize friction at every step.
</context>

<PRD>
# Technical Architecture  

**Database Schema Additions** (Build on existing schema):

```sql
-- Add address/district fields to profiles table
ALTER TABLE profiles ADD COLUMN address_line1 TEXT;
ALTER TABLE profiles ADD COLUMN address_line2 TEXT;
ALTER TABLE profiles ADD COLUMN city TEXT;
ALTER TABLE profiles ADD COLUMN state TEXT;
ALTER TABLE profiles ADD COLUMN zip_code TEXT;
ALTER TABLE profiles ADD COLUMN county TEXT;
ALTER TABLE profiles ADD COLUMN legislative_district TEXT;
ALTER TABLE profiles ADD COLUMN congressional_district TEXT;
ALTER TABLE profiles ADD COLUMN legislative_district_id UUID;
ALTER TABLE profiles ADD COLUMN latitude NUMERIC;
ALTER TABLE profiles ADD COLUMN longitude NUMERIC;
ALTER TABLE profiles ADD COLUMN geocoded_at TIMESTAMPTZ;

-- Update profiles table to support new leadership roles
-- Existing role column: CHECK (role IN ('general', 'captain', 'warrior'))
-- Update to: CHECK (role IN ('national_leader', 'state_leader', 'county_leader', 'captain', 'warrior'))
ALTER TABLE profiles DROP CONSTRAINT IF EXISTS profiles_role_check;
ALTER TABLE profiles ADD CONSTRAINT profiles_role_check CHECK (role IN (
  'national_leader', 'state_leader', 'county_leader', 'captain', 'warrior'
));

-- Add leadership scope tracking to profiles
ALTER TABLE profiles ADD COLUMN leadership_state TEXT; -- e.g., "Maryland" for state leaders
ALTER TABLE profiles ADD COLUMN leadership_county TEXT; -- e.g., "Montgomery" for county leaders

-- Create legislative_districts table (replaces warrior_bands for geographic hierarchy)
CREATE TABLE legislative_districts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  state TEXT NOT NULL, -- e.g., "Maryland", "Florida", "South Carolina"
  county TEXT NOT NULL, -- e.g., "Montgomery", "Miami-Dade"
  district_name TEXT NOT NULL, -- e.g., "District 15", "District 27"
  district_code TEXT NOT NULL, -- e.g., "MD-15", "FL-27"
  captain_id UUID REFERENCES auth.users(id), -- The assigned captain
  assigned_by UUID REFERENCES auth.users(id), -- Who assigned this captain (County/State/National leader)
  assigned_at TIMESTAMPTZ, -- When captain was assigned
  party_id UUID NOT NULL REFERENCES parties(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(state, county, district_name)
);

-- Add mission type fields to directives table
ALTER TABLE directives ADD COLUMN mission_type TEXT CHECK (mission_type IN (
  'RECRUIT_FRIENDS', 
  'SIGNAL_BOOST', 
  'RAID_COMMENTS', 
  'PHONE_EMAIL_PROTEST', 
  'PFP_CHANGE', 
  'EVENT_ATTENDANCE', 
  'VOTER_REGISTRATION'
));
ALTER TABLE directives ADD COLUMN verification_method TEXT CHECK (verification_method IN (
  'photo', 'screenshot', 'social_api', 'manual', 'invite_code'
));
ALTER TABLE directives ADD COLUMN xp_reward INT NOT NULL DEFAULT 50;
ALTER TABLE directives ADD COLUMN scope_level TEXT CHECK (scope_level IN (
  'district', 'county', 'state', 'national'
)) NOT NULL DEFAULT 'district';
ALTER TABLE directives ADD COLUMN target_legislative_district_id UUID REFERENCES legislative_districts(id);
ALTER TABLE directives ADD COLUMN target_county TEXT;
ALTER TABLE directives ADD COLUMN target_state TEXT;
ALTER TABLE directives ADD COLUMN social_platform TEXT; -- e.g., "twitter", "reddit", "instagram"
ALTER TABLE directives ADD COLUMN target_url TEXT; -- URL for signal boost/raid missions
ALTER TABLE directives ADD COLUMN raid_keyword TEXT; -- Keyword to verify in raid screenshots
ALTER TABLE directives ADD COLUMN pfp_description TEXT; -- Description for PFP change missions
ALTER TABLE directives ADD COLUMN phone_email_target TEXT; -- Phone/email for protest missions
ALTER TABLE directives ADD COLUMN phone_email_script TEXT; -- Script/talking points

-- Mission type XP lookup table (fixed values, leaders cannot change)
CREATE TABLE mission_type_xp (
  mission_type TEXT PRIMARY KEY,
  xp_reward INT NOT NULL,
  verification_method TEXT NOT NULL
);

INSERT INTO mission_type_xp (mission_type, xp_reward, verification_method) VALUES
  ('RECRUIT_FRIENDS', 100, 'invite_code'),
  ('SIGNAL_BOOST', 50, 'screenshot'),
  ('RAID_COMMENTS', 75, 'screenshot'),
  ('PHONE_EMAIL_PROTEST', 150, 'screenshot'),
  ('PFP_CHANGE', 25, 'screenshot'),
  ('EVENT_ATTENDANCE', 100, 'photo'),
  ('VOTER_REGISTRATION', 150, 'photo');

-- Ballot system tables
CREATE TABLE mission_ballots (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  state TEXT NOT NULL,
  county TEXT,
  legislative_district TEXT,
  election_date DATE NOT NULL,
  election_name TEXT NOT NULL, -- e.g., "2026 Maryland Primary"
  created_by UUID NOT NULL REFERENCES auth.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE ballot_endorsements (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ballot_id UUID NOT NULL REFERENCES mission_ballots(id) ON DELETE CASCADE,
  race_title TEXT NOT NULL, -- e.g., "Governor", "State Senate District 15", "County Executive"
  candidate_name TEXT NOT NULL,
  candidate_party TEXT,
  position_order INT NOT NULL, -- Order on ballot (top to bottom)
  is_endorsed BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- User ballot commitments (track who committed to vote for endorsed candidates)
CREATE TABLE ballot_commitments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  ballot_id UUID NOT NULL REFERENCES mission_ballots(id) ON DELETE CASCADE,
  endorsement_id UUID NOT NULL REFERENCES ballot_endorsements(id) ON DELETE CASCADE,
  committed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  verified_at TIMESTAMPTZ,
  verification_photo_url TEXT,
  UNIQUE(user_id, endorsement_id)
);
```

**API Integrations**:
- **Mapbox Geocoding API**: Already have token (`EXPO_PUBLIC_MAPBOX_ACCESS_TOKEN`). Use Geocoding API endpoint: `https://api.mapbox.com/geocoding/v5/mapbox.places/{address}.json?access_token=...`. Returns lat/lng. Then map to Maryland district using lookup table.
- **Google Gemini 1.5 Flash**: Already integrated via Edge Function. Extend to verify raid keywords in screenshots, PFP changes, etc.
- **Social Media APIs** (Future): Twitter/X API for automatic verification. For MVP, use screenshot verification.

**Geographic Lookup System**:
- Create `maryland_district_lookup.json` with polygon boundaries for each legislative district (can use Maryland Open Data or manual entry for Montgomery County first)
- Simple point-in-polygon check: Given lat/lng, find which district polygon contains it
- Scalable to Florida, South Carolina by adding more lookup files per state
- Fallback: If geocoding fails or district not found, allow manual district selection

**Notification Scope Logic** (when push notifications implemented):
- User's legislative_district_id → receives District-level missions
- User's county → receives County-level missions
- User's state → receives State-level missions
- All users → receive National-level missions
- Notification channels: One channel per scope level

**Mission Creation Flow**:
1. Captain opens HQ Tab → Missions
2. Dropdown selects mission type (e.g., "SIGNAL_BOOST")
3. Form dynamically shows relevant fields:
   - SIGNAL_BOOST: target_url, social_platform, description
   - RAID_COMMENTS: target_url, raid_keyword, social_platform, description
   - PHONE_EMAIL_PROTEST: phone_email_target, phone_email_script, description
   - PFP_CHANGE: pfp_description, duration, description
   - RECRUIT_FRIENDS: description only
   - EVENT_ATTENDANCE: description, optional geofence
   - VOTER_REGISTRATION: description
4. Scope selector: District (current district) / County / State / National
5. Auto-populate xp_reward and verification_method from mission_type_xp table (read-only)
6. Click "Create Mission" → Insert into directives table with mission_type, scope_level, target fields
7. Mission appears in Command Feed for users in scope

**Link Opening System**:
- Use `expo-web-browser` for in-app browser
- Use `expo-linking` for deep links to native apps
- URL scheme detection: `twitter://`, `reddit://`, etc.
- Mission cards show "Open Link" button that calls:
  ```typescript
  const openMissionLink = async (url: string) => {
    const canOpen = await Linking.canOpenURL(url);
    if (canOpen) {
      await Linking.openURL(url); // Opens native app
    } else {
      await WebBrowser.openBrowserAsync(url); // Opens in-app browser
    }
  };
  ```

# Development Roadmap  

**Phase 1: Database Foundation & Address System** (Critical Path)
- Create and run migration SQL to add all new tables and columns
- Update profiles.role constraint to include new leadership roles (national_leader, state_leader, county_leader, captain, warrior)
- Seed mission_type_xp lookup table with fixed XP values
- Create legislative_districts table and seed **ALL 47 Maryland legislative districts** across all 23 counties (Montgomery, Baltimore, Anne Arundel, etc.)
- **Initial focus**: Montgomery County (Districts 14-20) + MD-6 Congressional District, but infrastructure supports statewide expansion
- Add address entry screen to onboarding flow (after personal-details, before feature-selection)
- Integrate Mapbox Geocoding API: Address form → API call → lat/lng → Maryland district lookup (all 47 districts)
- Auto-assign users to legislative_district_id based on geocoded address
- Update auth guard to include address verification step
- Fallback UI: If geocoding fails, show manual district selector dropdown (all 47 districts available)

**Phase 2: Captain Assignment System** (Critical Path - Leadership Tools)
- Create "Leadership" tab in HQ screen (visible only to county_leader, state_leader, national_leader roles)
- **County Leader UI**: View all districts in their county → Select district → Search users in that district → Assign as Captain → Updates legislative_districts.captain_id, assigned_by, assigned_at
- **State Leader UI**: View all counties in their state → Drill down to districts → Assign Captains OR assign County Leaders
- **National Leader UI**: View all states → Drill down to states/counties/districts → Assign leaders at any level
- RLS policies: Only users with leadership role at correct scope can assign captains (e.g., County Leader can only assign captains in their county)
- Captain receives notification when assigned: "You've been assigned as Captain of Maryland District 15"
- Once assigned, user's role automatically updated to 'captain' and warrior_band_id set to legislative_district_id
- **Assignment validation**: Cannot assign same captain to multiple districts (one captain = one district)
- **Reassignment support**: County/State/National leaders can reassign captains (unassign current, assign new)

**Phase 3: Mission Creation UI (HQ Tab Enhancement)** (Critical Path)
- Update command-center screen to add "Missions" tab (alongside Directives and Bands)
- Build mission type dropdown component with 7 options
- Implement dynamic form fields that change based on selected mission type
- **Scope level selector logic** (role-based):
  - **Captain**: Scope auto-set to "District" (their assigned district only, cannot change)
  - **County Leader**: Scope options: "Specific District" (dropdown of districts in county) OR "Entire County"
  - **State Leader**: Scope options: "Specific District", "Specific County" (dropdown), OR "Entire State"
  - **National Leader**: Scope options: "Specific District", "Specific County", "Specific State" (dropdown), OR "National"
- Auto-populate XP reward and verification method from database (read-only display)
- Create mission function: Validate fields → Insert into directives with mission_type, scope_level, target_legislative_district_id (if specific district), target_county (if county), target_state (if state)
- Update Command Feed (index screen) to show mission cards with mission-specific UI (e.g., "Open Link" button for social missions)
- **Filter missions by user's scope**: Show missions for their district + county + state + national (hierarchical visibility)

**Phase 4: Easy Link Opening for Social Missions** (Quick Win)
- Add expo-web-browser and expo-linking to package.json
- Create openMissionLink utility function with deep link support
- Update mission cards in Command Feed to show "Open Link" button for SIGNAL_BOOST and RAID_COMMENTS types
- Support URL schemes: twitter://, reddit://, instagram://, youtube://
- Fallback to in-app browser if native app not installed
- Test with real Twitter, Reddit, Instagram URLs

**Phase 5: Mission Verification Enhancements** (Build on existing)
- Extend existing Gemini Edge Function to handle new mission types
- RAID_COMMENTS: Check screenshot for raid_keyword presence
- PFP_CHANGE: Verify screenshot shows new profile picture matching pfp_description
- SIGNAL_BOOST: Verify screenshot shows engagement (like/share/retweet)
- PHONE_EMAIL_PROTEST: Verify screenshot shows call log or email sent
- EVENT_ATTENDANCE: Verify photo shows event (use existing photo verification)
- VOTER_REGISTRATION: Verify photo shows forms (use existing photo verification)
- RECRUIT_FRIENDS: Track via invite codes (already implemented)

**Phase 6: Digital Ballot Voting Guide** (High Impact)
- Create Main Quest screen (new tab or route)
- Build ballot UI: Replica of real ballot design with race titles and candidate names
- Fetch user's ballot based on legislative_district_id and upcoming election_date
- Highlight endorsed candidates (is_endorsed = true) in Neon Green
- Show race titles in order (position_order)
- "Commit to Vote" button per race → Insert into ballot_commitments
- Track completionist progress: How many endorsed candidates user committed to
- "I Voted" proof upload: Photo of "I Voted" sticker or ballot
- Completionist badge logic: Award high XP (e.g., 500 XP) if user verifies voting for ALL endorsed candidates

**Phase 7: Ballot Management UI (State/National Leadership)** (Admin Tool)
- Create admin screen for General/State leadership only (role-gated)
- "Create Ballot" form: Select state, county, district, election date, election name
- "Add Race" form: Race title, position order
- "Add Candidate" form: Candidate name, party, is_endorsed checkbox
- "Preview Ballot" view: See how ballot will look to voters
- "Publish Ballot" button: Makes ballot active for users
- List all ballots with edit/delete options

**Phase 8: Notification Discipline & Strategy** (Retention Focus)
- Track notification permission status in user_preferences table
- Add notification permission prompt after onboarding (or defer to first mission)
- Onboarding warning screen: "Disabling notifications means missing critical election night intel. Keep them ON to never miss an election."
- Notification scheduling logic (when push notifications enabled):
  - New mission in user's scope → Immediate push
  - Mission verification result → Immediate push
  - Election day reminder → Send day before, morning of, and 2 hours before polls close
  - Weekly digest → Sunday evening (opt-in only)
  - Critical updates → Only for major events (Polymarket odds shifts >3%, candidate drops out, etc.)
- Notification preferences UI: Let users choose frequency (All, Important Only, Election Day Only, Off)
- Analytics dashboard: Track notification opt-in rate per district/state

**Phase 9: Map Territory Game (Stretch Goal - Optional)** (Nice-to-Have)
- Increase H3 resolution from Res 9 to Res 7 or 8 (larger hexes)
- Create territory_claims table: hex_h3_index, claimed_by_party_id, claimed_at, status
- Leadership UI: Mark hexes as "enemy territory" (red) or "our territory" (green)
- Update map screen to show territory colors (enemy red, ours green, unclaimed dark)
- Siege mechanic: Track check-ins per hex, convert enemy hex to ours after threshold (e.g., 50 check-ins within 7 days)
- Territory leaderboard: Which districts control most territory
- **If too complex or timeline too tight, skip this entire phase**

**Phase 10: Multi-State Expansion Prep** (Scalability)
- Create Florida legislative district lookup table
- Create South Carolina legislative district lookup table
- Update address geocoding to detect state and use correct lookup
- Allow Generals to create parties per state (e.g., "Hard Party - Florida", "Hard Party - South Carolina")
- State-scoped missions: Only users in that state see state missions
- Test end-to-end flow with Florida and South Carolina addresses

**Phase 11: Testing & Launch Prep** (Production Readiness)
- End-to-end testing: New user onboarding → Address entry → Mission creation → Mission completion → Ballot voting guide → Verification
- Performance testing: 10,000+ users, 1,000+ missions, real-time updates
- Notification testing: Ensure valuable, not spammy
- Captain training: Real Montgomery County captains test mission creation UI, provide feedback
- Database backups and disaster recovery plan
- App Store and Google Play Store deployment
- Beta testing with 100 real Montgomery County users
- Launch countdown: 90 days before 2026 Primary (allows time to recruit and train users)

# Logical Dependency Chain

**Foundation Must Come First**: Phase 1 (Database & Address System) is blocking for everything else. Cannot create missions without legislative_districts table. Cannot assign captains without districts. Cannot auto-assign users without address geocoding.

**Captain Assignment Before Mission Creation**: Phase 2 (Captain Assignment System) must come after Phase 1 but before Phase 3. County/State/National leaders need to assign Captains to districts before Captains can create missions. This is the chain of command.

**Mission Creation After Captain Assignment**: Phase 3 (Mission Creation UI) requires Phase 2 to be complete. Cannot create missions without captains assigned to districts.

**Link Opening Can Be Parallel**: Phase 4 (Easy Link Opening) can be built alongside Phase 3. Just UI enhancement, no database dependencies.

**Mission Verification After Mission Creation**: Phase 5 (Verification Enhancements) must come after Phase 3. Cannot verify missions that don't exist yet.

**Ballot System Depends on Districts**: Phase 6 (Digital Ballot) requires Phase 1 (legislative_districts) to be complete so we can scope ballots per district. Can be built in parallel with Phases 2-5.

**Ballot Management After Ballot Display**: Phase 7 (Ballot Management UI) should come after Phase 6 (Ballot Display) so State/National leaders can see what they're creating.

**Notifications Can Wait**: Phase 8 (Notification Discipline) can come later. App works without push notifications. Focus on core mission system first.

**Map Territory Game is Optional**: Phase 9 can be skipped entirely if timeline is tight. Map improvements are nice-to-have, not critical path.

**Multi-State Expansion After Maryland MVP**: Phase 10 (Florida/South Carolina) should come after Montgomery County + all Maryland is working perfectly. Don't scale broken features. Maryland infrastructure already supports 47 districts.

**Testing Throughout**: Phase 11 (Testing) should happen continuously, not just at the end. Test each phase as it's built.

**Critical Path for MVP Launch**: Phase 1 (Database) → Phase 2 (Captain Assignment) → Phase 3 (Mission Creation) → Phase 4 (Link Opening) → Phase 5 (Verification) → Phase 6 (Ballot) → Phase 7 (Ballot Management) → Phase 11 (Testing). Everything else is parallel or deferred.

**Quick Wins for Leadership Buy-In**: 
- Get Phase 2 (Captain Assignment) working to show County/State leaders "You can easily assign captains to districts"
- Get Phase 3 (Mission Creation) working to show Captains "Look how easy it is to create a mission!"
- Get Phase 4 (Link Opening) working to show Warriors "One tap to raid target posts!"

# Risks and Mitigations  

**Risk: Notification Opt-Out Hurts Turnout**
- Mitigation: Make notifications extremely valuable, not annoying. Only send election-critical info. Track opt-out rate as key metric. A/B test notification content. Warn users during onboarding. Aim for >80% opt-in rate.

**Risk: District Data Accuracy for Maryland**
- Mitigation: Start with Montgomery County only (6 districts). Use simple lookup table. Can enhance with full GeoJSON dataset later. Fallback to manual district selection if geocoding fails. Test with real Montgomery County addresses.

**Risk: Captain Confusion with Mission Creation UI**
- Mitigation: Make dropdown dead simple. Dynamic form fields reduce errors. Clear tooltips and examples. Test with real captains before launch. Provide training videos. In-app help text for each mission type.

**Risk: Screenshot Verification False Positives/Negatives**
- Mitigation: Use Gemini 1.5 Flash with strict prompts. Include raid_keyword check for raids. Manual review fallback for disputed verifications. Allow users to appeal rejected proofs. Captain can manually approve if AI fails.

**Risk: Map Territory Game Too Complex**
- Mitigation: Mark as optional Phase 8. Can remove entirely if not feasible. Focus on core mission system first. Map improvements are nice-to-have. Don't let perfect be enemy of good.

**Risk: Address Privacy Concerns**
- Mitigation: Clear privacy policy during address entry. Explain it's only for district assignment. Do not share addresses with other users. Store lat/lng rounded to 3 decimal places (reduces precision to ~100m). Optional: Allow manual district selection if user doesn't want to share address.

**Risk: Election Day Reliability**
- Mitigation: App must work perfectly on election day. Offline queue system already exists. Extensive load testing before launch. Database backups. Disaster recovery plan. Test with 10,000+ users. Monitor server load on election day.

**Risk: Multi-State Scaling Challenges**
- Mitigation: Build Maryland first, scale after proven. Separate legislative_districts per state. Test Florida and South Carolina thoroughly before launch. Don't rush multi-state until Montgomery County is stable.

**Risk: Captain Recruitment and Training**
- Mitigation: Manual Captain assignment after interviews. Provide training materials (videos, PDFs). Test mission creation UI with real captains. Gather feedback early. Make UI so simple that minimal training is needed.

**Risk: Ballot Endorsement Accuracy**
- Mitigation: General/State leadership manually creates ballots. Double-check candidate names and races. Preview ballot before publishing. Allow edits after publishing. Verify ballot matches official sample ballot. Legal review of endorsement language.

**Risk: Timeline Too Aggressive for 2026 Primary**
- Mitigation: Focus on Montgomery County MVP only. Defer Florida and South Carolina to later. Skip map territory game if needed. Launch 90 days before primary to allow user recruitment. Start with core mission system, iterate based on feedback.

# Appendix  

**Mission Type XP Values** (Fixed, leaders cannot customize):
```
RECRUIT_FRIENDS: 100 XP (verification: invite_code tracking)
SIGNAL_BOOST: 50 XP (verification: screenshot)
RAID_COMMENTS: 75 XP (verification: screenshot with keyword check)
PHONE_EMAIL_PROTEST: 150 XP (verification: screenshot)
PFP_CHANGE: 25 XP (verification: screenshot)
EVENT_ATTENDANCE: 100 XP (verification: photo)
VOTER_REGISTRATION: 150 XP (verification: photo)
```

**Verification Method Auto-Assignment**:
```
RECRUIT_FRIENDS → invite_code (track via invites table)
SIGNAL_BOOST → screenshot (Gemini checks for engagement UI)
RAID_COMMENTS → screenshot (Gemini checks for raid_keyword presence)
PHONE_EMAIL_PROTEST → screenshot (Gemini checks for call log or email)
PFP_CHANGE → screenshot (Gemini checks for profile picture)
EVENT_ATTENDANCE → photo (Gemini checks for event context)
VOTER_REGISTRATION → photo (Gemini checks for forms)
```

**Role & Geographic Hierarchy Structure**:
```
National Leader (Top of chain of command)
  ↓ assigns
State Leader (e.g., Maryland)
  ↓ assigns
County Leader (e.g., Montgomery County)
  ↓ assigns
Captain (ONE Legislative District, e.g., MD-15)
  ↓ creates missions for
Warrior (User auto-assigned by address)

Leadership Assignment Authority:
- National Leader: Can assign State Leaders, County Leaders, or Captains anywhere
- State Leader: Can assign County Leaders or Captains within their state
- County Leader: Can assign Captains within their county
- Captain: Cannot assign anyone, only creates missions for their district
- Warrior: No assignment authority
```

**Notification Scope Logic**:
```
User receives notifications for:
- Their Legislative District missions (created by their Captain)
- Their County missions (created by County Leader)
- Their State missions (created by State Leader)
- National missions (created by National Leader)

Example: Warrior in MD-15, Montgomery County, Maryland receives:
- District missions from Captain of MD-15
- County missions from Montgomery County Leader
- State missions from Maryland State Leader
- National missions from National Leader

Mission Visibility by Role:
- Captain: Can ONLY create missions for their assigned district
- County Leader: Can create missions for specific districts in their county OR entire county
- State Leader: Can create missions for specific districts, counties, OR entire state
- National Leader: Can create missions for any scope
```

**Maryland Legislative Districts** (All 47 districts seeded, Montgomery County + MD-6 priority):
```
Montgomery County (Initial Target):
- District 14 (Germantown, Clarksburg)
- District 15 (Gaithersburg, Kentlands)
- District 16 (Olney, Brookeville)
- District 17 (Potomac, Bethesda)
- District 18 (Chevy Chase, Kensington)
- District 19 (Silver Spring, Montgomery Hills)
- District 20 (Takoma Park, Langley Park)

Other Counties (Infrastructure ready for expansion):
- Baltimore County: Districts 7, 8, 10, 11, 42, 44
- Anne Arundel County: Districts 30, 31, 32, 33
- Prince George's County: Districts 21, 22, 23, 24, 25, 26, 27, 47
- Howard County: Districts 9, 12, 13
- Frederick County: Districts 3, 4
- Harford County: Districts 6, 34A, 34B
- Carroll County: District 5
- Baltimore City: Districts 40, 41, 43, 45, 46
- ... (and 15 more counties with their respective districts)

Total: All 47 Maryland Legislative Districts seeded in database
Focus: Montgomery County + MD-6 Congressional District for initial launch
Expansion: Ready to scale to any Maryland county immediately
```

**Ballot Example Structure** (For Montgomery County 2026 Primary):
```
Race 1: Governor (position_order: 1)
  - Candidate A (endorsed: true) ← Neon Green highlight
  - Candidate B (endorsed: false)

Race 2: U.S. Senate (position_order: 2)
  - Candidate C (endorsed: true) ← Neon Green highlight
  - Candidate D (endorsed: false)

Race 3: U.S. House MD-6 (position_order: 3)
  - Candidate E (endorsed: true) ← Neon Green highlight
  - Candidate F (endorsed: false)

Race 4: State Senate District 15 (position_order: 4)
  - Candidate G (endorsed: true) ← Neon Green highlight
  - Candidate H (endorsed: false)

Race 5: Montgomery County Executive (position_order: 5)
  - Candidate I (endorsed: true) ← Neon Green highlight
  - Candidate J (endorsed: false)
```

**Notification Strategy Examples**:
```
✅ GOOD Notification: "New mission in District 15: Signal Boost - Share the town hall post"
❌ BAD Notification: "Hey! Check out the app! We have new stuff!"

✅ GOOD Notification: "ELECTION DAY: Polls close in 2 hours. Vote for our team!"
❌ BAD Notification: "Daily reminder: You should vote sometime!"

✅ GOOD Notification: "Mission verified! +50 XP. You're 50 XP from Centurion!"
❌ BAD Notification: "Thanks for participating!"

✅ GOOD Notification: "ALERT: Candidate Jones dropped out. Check updated ballot."
❌ BAD Notification: "We have updates. Check the app."
```

**Scalability Plan for Multi-State Expansion**:
```
Phase 1: Montgomery County, Maryland (6 districts, target 10,000 users)
Phase 2: Full Maryland (47 districts, target 50,000 users)
Phase 3: Florida Governor race (40 districts, target 100,000 users)
Phase 4: South Carolina races (46 districts, target 50,000 users)
Phase 5: Nationwide (all states, target 1,000,000+ users)
```

**Technical Stack Summary** (Building on existing):
```
Frontend: Expo, React Native, Expo Router, Nativewind (already built ✅)
Backend: Supabase PostgreSQL, Auth, Realtime, Storage (already built ✅)
Maps: Mapbox + H3 (already built ✅)
AI: Google Gemini 1.5 Flash (already built ✅)
Offline: expo-sqlite (already built ✅)

NEW Additions for Phase 2:
- expo-web-browser (link opening)
- expo-linking (deep links)
- Mapbox Geocoding API (address → district)
- District lookup tables (Maryland, Florida, South Carolina)
- Mission creation UI (dropdown system)
- Ballot system (digital voting guide)
- Notification strategy (discipline & retention)
```
</PRD>
