<context>
# Overview
Salvo is a mission-critical community coordination app: a hierarchy-driven action engine that turns digital intent into real-world presence. It is not a social network. It uses a strict social contract (The Oath) and a meritocratic rank system so only verified, active members gain access to higher-level Spoils and Directives. Problem: communities struggle to turn online intent into measurable, verified real-world action. Who it's for: organized political/community groups (e.g. The Hard Party) with a clear chain of command (General, Captains, Warriors/Recruits). Success: users sign The Oath, complete AI-verified missions, contribute Salvos to per-directive goals, and reveal map tiles by checking in—with real-time feedback and offline-tolerant behavior.

# Core Features
The Gates (Auth): Level 0 after Oath; advancement to Warrior (Level 5) requires 3 AI-verified missions; Centurion (Level 10) manually approved. Command Feed: one-way directives from General; each directive has target_goal for Pillage Meter; scoped to party or specific Warrior Bands. Pillage Meter: per-directive reset; real-time via Supabase Realtime. Fog of War: H3 hex grid Resolution 9; 3D tactical map; tiles revealed only on check-in; no pre-seed. Proof of Action: async AI verification via Edge Function plus Gemini 1.5 Flash. Hierarchy: General, Captain, Warrior (single role column in profiles). The Oath: hard gate; scroll-to-bottom plus signature; store oath_signed_at and contract_version_id. Offline: expo-sqlite queue for check-ins and Raids; best-effort sync.

# User Experience
Personas: General (sends directives), Captain (leads band), Recruit/Officer (Warrior) (completes missions, Raids, check-ins). Command Flow (from flow map): Recruit or Officer logs in; View Command Feed (Active Directives); Select Mission or Raid (e.g. Target: School Board); Internal Ghost Primary (Choose Target) may influence which targets or missions are available; Execute Directive (One-Tap Call or Email); Upload Proof of Action (Photo or Screenshot); AI Vision Verification (Processing); Victory Screen Unlocked (XP plus Rank Up); View Territory Map (Check Capture Progress). UI: Tactical UI aesthetic per Visual Identity (Citizen-style dark theme, War Log-style Command Feed with green for completed directives, Call of Duty-style stats and comparison). Oath full-screen until signed; map 3D tilted; Mapbox FillLayers for H3 hexagons; Pillage Meter real-time (consider circular gauge); Raid button debounced; rate limit 10 per 60 seconds per user server-side.
</context>
<PRD>
# Technical Architecture
Visual Identity: Citizen App base (dark theme, clean feed); Command Feed as War Log style (green for completed, one card per directive); Call of Duty-style stats (level, rank, XP, circular gauges, compare and look up other accounts); map Citizen-style dark with Hard Party Green for revealed H3 tiles. Stack: Frontend Expo (React Native), Expo Router, Nativewind, Reanimated. Backend Supabase (PostgreSQL, Auth, Realtime, Storage, Edge Functions). Maps Mapbox via @rnmapbox/maps, H3 Resolution 9. AI Gemini 1.5 Flash via Edge Functions. Offline expo-sqlite. Auth gate (The Gates): Oath screen hard blocking overlay; no app access until oath_signed_at and contract_version_id set; scroll-to-bottom mandatory; Join disabled until scroll complete. Roles: profiles.role in general, captain, warrior; only General can insert directives (RLS). Pillage Meter: per-directive target_goal; count from salvos; real-time via Supabase Realtime. Raid: one tap one salvo; rate limit 10 per 60 seconds per user (RLS); client debounce. Fog of War: H3 Res 9; no pre-seed; h3_tiles rows created on first check-in via trigger; Mapbox FillLayers fog and revealed. AI verification: async; Edge Function on user_missions submitted; Gemini 1.5 Flash TRUE or FALSE; update verified or rejected; award_mission_xp_and_recompute_rank. Offline: expo-sqlite tables pending_check_ins, pending_salvos; sync on foreground or network restore. Data model: contract_versions, ranks, parties, warrior_bands, profiles (role, oath_signed_at, contract_version_id), directives, directive_bands, salvos, missions, user_missions, h3_tiles, check_ins. Schema in docs/schema.sql includes all tables, RLS policies, triggers, recompute_user_rank, award_mission_xp_and_recompute_rank, can_user_submit_salvo.

# Development Roadmap
Phase 1 The Gates (Foundation and Auth): Create Supabase project; enable Auth Email and Phone, Realtime, Storage. Run docs/schema.sql in Supabase SQL Editor (all tables, RLS, triggers, Rank and XP functions, seed contract_versions and ranks). Expo: ensure Nativewind, Reanimated, expo-router; add Supabase client and env SUPABASE_URL and SUPABASE_ANON_KEY. Implement Oath screen as hard blocking overlay in tactical UI style (Citizen-inspired dark theme, high-contrast text, minimal chrome): if profile missing or oath_signed_at null show only Oath screen. Oath UI: scroll-to-bottom mandatory; Join button disabled until scroll complete; on sign call Supabase to set oath_signed_at and contract_version_id and create or update profile with party_id Hard Party level 0 role warrior. Then allow app entry. Contract versioning: contract_versions table with one seed row; profiles.contract_version_id references it.

Phase 2 Command Feed and Pillage Meter: Command Feed screen in War Log style with Citizen aesthetic: dark theme, one card or row per directive with timestamp, bold title, short description, Pillage Meter progress (current_salvos divided by target_goal), and green accent for completed directives (Hard Party Green); list directives for party and user band; read-only for non-General. Directive detail screen show title body target_goal and Pillage Meter; consider Call of Duty-style circular or semi-circular gauge for meter. Fetch directive and count salvos for directive_id. Subscribe to Supabase Realtime for salvos filtered by current directive_id; update meter in UI. Raid button (tactical accent color): on tap debounce then insert one row into salvos user_id directive_id; enforce rate limit in RLS; update local state; let Realtime refresh meter. Align with flow map: user views Command Feed then selects Mission or Raid (e.g. Target: School Board); Execute Directive is the one-tap Raid.

Phase 3 Ranks Missions and AI Verification: Seed or ensure ranks table has Recruit Warrior Centurion. Profile screen in Call of Duty-style stats: display rank level XP prominently (large bold numbers, clear hierarchy); support compare stats and look up other accounts (view other users' level, rank, XP, Salvos or completed directives) in same tactical dark UI. Missions list for party and user band; user can Start mission create user_mission pending; Submit proof upload photo to Storage set proof_photo_url and status submitted. Edge Function triggered on user_mission insert or update when status submitted and proof_photo_url set: call Gemini 1.5 Flash with image and mission description; parse TRUE or FALSE; update user_mission verified or rejected verified_at verified_by; call award_mission_xp_and_recompute_rank. Centurion promotion remains manual by General. Victory screen on verification success: Hard Party Green accent, clear XP plus Rank Up message, tactical style. Align with flow map: Upload Proof of Action, AI Vision Verification, Victory Screen Unlocked (XP plus Rank Up).

Phase 4 Map and Fog of War: Add @rnmapbox/maps; map screen in Citizen-style dark base map (dark grey or black background, light street labels), 3D perspective pitch bearing user location follow. Resolve user location or tap to H3 index Resolution 9 using h3-js. Fetch h3_tiles for viewport or region; no pre-seed tiles created on first check-in. Check-in flow: user taps Check in; client gets current H3 index; insert check_in user_id h3_index event_type region; trigger ensures h3_tiles row exists and status revealed. Map two FillLayers fog all hexagons dark and revealed only revealed tiles Hard Party Green; GeoJSON from H3 boundaries. Realtime subscribe to h3_tiles or check_ins for visible region to update map. Map controls: minimal, light icons on dark (Citizen-style). Align with flow map: View Territory Map (Check Capture Progress).

Phase 5 Offline Queue and Sync: Add expo-sqlite. Local schema pending_check_ins and pending_salvos with user_id h3_index or directive_id event_type or action_type created_at. When user taps Check in or Raid and offline insert into local queue; UI show Queued will sync when online. Sync service on app foreground or network restore: drain queue insert check_ins and salvos to Supabase; remove from queue on success; if rate limit hit leave salvo in queue retry later.

Phase 6 Hierarchy and Directive Scoping: Enforce RLS so only role general can insert and update directives; directive creation form or screen only for General in tactical UI (dark theme, clear form fields). Directive scoping: directive_bands empty means party-wide; rows mean only those bands see and contribute; Command Feed and Pillage Meter filter by party_id and empty directive_bands or user warrior_band_id in directive_bands. Warrior Bands: Captains can create warrior_bands and assign members profiles.warrior_band_id; list bands and members in settings or admin; stats comparison and look-up-other-accounts use same Call of Duty-style presentation (level, rank, XP, optional Salvos). Internal Ghost Primary (Choose Target): implement or document how targets or missions are chosen or filtered for display (e.g. by directive_bands or party).

Future enhancements out of scope: Centurion approval UI; push notifications; analytics dashboard; multi-tenancy.

# Logical Dependency Chain
The Gates first: schema, Auth, Oath gate. Nothing else is usable without these. Then Command Feed and Pillage Meter for visible value (user can log in, see directives, execute one-tap Raid, see meter). Then Ranks missions AI verification (progression and proof; Victory Screen XP and Rank Up). Then Map and Fog of War (territory and check-ins; Territory Map). Then Offline queue and sync (resilience). Then full hierarchy and directive scoping (General-only create, bands, Ghost Primary target selection).

# Risks and Mitigations
H3 tile count: Res 9 and no pre-seed keep DB small. Rate limit and debounce: enforce server-side; document for client. MVP scope: phases 1 through 6 atomic; use task-master parse-prd to break into tasks; implement Task 1 first (The Gates).

# Appendix
Visual Identity: Citizen App base (dark theme, notification-style clarity, colors). Command Feed: War Log style (one entry per directive, timestamp, metrics, green for completed) with Citizen aesthetic. Stats: Call of Duty-style (level, rank, XP, circular gauges for Pillage Meter, compare stats, look up other accounts). Map: Citizen-style dark base; Hard Party Green for revealed H3 tiles. H3 Res 9 about 0.1 km². Supabase Realtime Postgres Changes for salvos. Gemini 1.5 Flash from Edge Function; store API key in Supabase secrets. expo-sqlite for offline queue only. Flow map reference: Recruit or Officer logs in, View Command Feed, Select Mission or Raid, Execute Directive (one-tap), Upload Proof, AI Verification, Victory Screen (XP and Rank Up), View Territory Map; Internal Ghost Primary (Choose Target) influences target selection.
</PRD>
